#!/bin/sh
# xinterp: interpret desktop commands

CACHEDIR="${CACHEDIR:-XDG_CACHE_HOME}"
CACHEDIR="${CACHEDIR:-$HOME/local/.cache}"
iconpath=${ICONPATH:-/usr/share/icons/hicolor/48x48}
promptcache="${CACHEDIR}/xprompt.cache"
menucache="${CACHEDIR}/pmenu.cache"

usage() {
	echo "usage: xinterp [prompt | menu]" >&2
	exit 1
}

genprompt() {
	echo "run	Run application"
	run | sed 's/^/	/'

	echo "mus	Play music"
	mus help | sed 's/^/	/'

	echo "scrot	Take screenshot"
	scrot help | sed 's/^/	/'

	echo "wm	Control windows"
	wm help | sed 's/^/	/'

	echo "man	Read manual"
	xman | sed 's/^/	/'

	echo "desk	Change desktop"
	echo "	next	Cycle through desktops in monitor forwards"
	echo "	prev	Cycle through desktops in monitor backwards"
	echo "	last	Go to last desktop in monitor"

	echo "term	Start terminal"

	echo "open	Open file"

	echo "exit	Exit X session"
}

menuentry() {
	n="$1"
	while [ "$n" -gt 0 ]
	do
		printf '\t'
		n=$((n - 1))
	done
	printf 'IMG:%s' "$(echo "$2" | icon | iconcache)"
	[ "$#" -eq 3 ] && printf '\t%s' "$3"
	printf '\n'
}

genmenu() {
	menuentry 0 "applications-other"
	run -i | sed 's/	/&run /; s/^/	/'

	menuentry 0 "preferences-system-windows"
	menuentry 1 "window-close" "wm close"
	menuentry 1 "view-fullscreen" "wm maximize"
	menuentry 1 "view-restore" "wm minimize"
	menuentry 1 "window-resize" "wm resize"

	menuentry 0 "applets-screenshooter" "scrot select"

	menuentry 0 "cd-audio"
	menuentry 1 "media-seek-forward"   "mus next"
	menuentry 1 "media-playback-stop"  "mus stop"
	menuentry 1 "media-seek-backward"  "mus prev"
	menuentry 1 "media-playback-pause" "mus toggle"

	menuentry 0 "terminal" "term"

	menuentry 0 "user-desktop"
	menuentry 1 "go-last"           "desk last"
	menuentry 1 "go-previous"       "desk prev"
	menuentry 1 "go-next"           "desk next"
}

notify() {
	cmd="$1"
	head -10 | while read l
	do
		case "$cmd" in
		'!'*)
			echo $cmd | cut -c2-
			;;
		esac
		cmd=""
		echo "$l"
	done | paste -s - >"$XNOTIFY_FIFO"
}

[ $# -gt 1 ] && usage

[ $# -eq 1 ] && case $1 in
prompt) genprompt >"$promptcache" ;;
menu)   genmenu >"$menucache" ;;
*)      usage ;;
esac && exit 0

while read -r cmd args
do
	case "$cmd" in
	'#'*)
		;;
	'!'*)
		cmd="$(echo $cmd | cut -c2-)"
		$cmd $args
		;;
	run)
		run $args
		;;
	mus)
		mus $args
		;;
	scrot)
		scrot $args
		;;
	wm)
		wm $args
		;;
	man)
		xman $args
		;;
	term)
		drawterm $args
		;;
	open)
		xopen "$args"
		;;
	desk)
		desk $args
		;;
	exit)
		pkill shod
		;;
	esac | notify $cmd &
done
