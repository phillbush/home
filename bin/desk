#!/bin/sh
# desk - change current desktop
# this file in public domain

operation="-s"

getdesk() {
	lsd | awk -F '[-*: ]+' -v DIR="$1" '
		/^\*/ { curr = NR }
		      { wins[NR] = $2 }
		END   {
			for (i = curr - 1; wins[i] && i > 0; i--)
				;
			first = i
			for (i = curr; wins[i] && i <= NR; i++)
				;
			last = i - 1

			if (DIR == "prev") {
				if (wins[curr - 1])
					print curr - 2
				else
					print last
			} else if (DIR == "next") {
				if (wins[curr])
					print curr
				else
					print first
			} else {
				print last
			}
		}
	'
}

printdesk() {
	lsd | awk -F '[-*: ]' '
		BEGIN        { printf "SEC:1\tIMG:'$ICONPATH'/places/user-desktop.png\tTAG:desk\t" }
		NR > 1 && !n { printf " " }
		/^\*/        { printf "●";  n = 0 }
		/^ /         { printf "○";  n = 0 }
		$2 == 0      { printf "\t"; n = 1 }
		END          { print "" }
	'
}

arg="$1"
if echo "$arg" | egrep -q '^\+'
then
	operation="-r :ACTIVE: -t"
	arg="$(echo "$arg" | cut -c2-)"
fi

case "$arg" in
prev)
	wmctrl $operation $(getdesk prev)
	;;
next)
	wmctrl $operation $(getdesk next)
	;;
last)
	wmctrl $operation $(getdesk last)
	;;
[0-9]*)
	wmctrl $operation $arg
	;;
esac
printdesk
