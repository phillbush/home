#!/bin/sh
# notify - send notifications when needed
# this file in public domain

bat() {
	batfull=$(sysctl hw.sensors.acpibat0.watthour0 | cut -d= -f2 | cut -d. -f1)
	batnow=$(sysctl hw.sensors.acpibat0.watthour3 | cut -d= -f2 | cut -d. -f1)
	printf "%s\n" "$((100 * batnow / batfull))"
}

charge() {
	[ "$(sysctl -n hw.sensors.acpibat0.raw0 | cut -d' ' -f1)" = "2" ]
}

temp() {
	sysctl hw.sensors.cpu0.temp0 | cut -d= -f2 | cut -d. -f1
}

clock() {
	date '+%y.%j/%m.%d/%V.%a %T'
}

powericon=$(echo "poweroff-cpu" | icon 128 s | iconcache 128)
hearticon=$(echo "heart" | icon 128 s | iconcache 128)

if [ $# -gt 0 ]
then
	printf "TAG:notify\t\
IMG:%s\t\
$(clock)\t\
Battery: %s%% (%s)\t\
Temperature: %s°C\
" "$powericon" "$(bat)" "$(charge && echo charging || echo discharging)" "$(temp)"   >"$XNOTIFY_FIFO"
	exit 0
fi

while true
do
	! charge && [ "$(bat)" -lt 20 ] && echo "SEC:0	TAG:power	IMG:$powericon	Battery is low: $(bat)%"
	[ "$(temp)" -gt 60 ] && echo "SEC:5	TAG:temp	IMG:$hearticon	Temperature is at $(temp)°C"
	sleep 60
done >"$XNOTIFY_FIFO"
